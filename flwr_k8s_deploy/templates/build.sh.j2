#!/bin/bash
# Build and push Docker image for multi-architecture deployment

set -e

# Configuration from flwr-k8s-config.yaml
IMAGE_NAME="{{ docker_username }}/{{ image_name }}"
VERSION="{{ tag }}"
PLATFORMS="{{ platforms }}"

echo "=========================================="
echo "Building Multi-Architecture Docker Image"
echo "=========================================="
echo "Image: ${IMAGE_NAME}:${VERSION}"
echo "Platforms: ${PLATFORMS}"
echo "=========================================="

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "❌ Error: Docker is not installed"
    exit 1
fi

# Check if logged into Docker
if ! docker info &> /dev/null; then
    echo "❌ Error: Docker daemon not running or not logged in"
    echo "Run: docker login"
    exit 1
fi

# Build for multiple architectures using buildx
if docker buildx version &> /dev/null; then
    echo "✅ Using Docker Buildx for multi-architecture build..."
    
    # Create and use a new builder if it doesn't exist
    if ! docker buildx inspect flwr-builder &> /dev/null; then
        echo "Creating new buildx builder..."
        docker buildx create --name flwr-builder --use --bootstrap
    else
        docker buildx use flwr-builder
    fi
    
    # Build and push multi-arch image
    echo "Building and pushing image..."
    docker buildx build \
        --platform ${PLATFORMS} \
        -t ${IMAGE_NAME}:${VERSION} \
        --push \
        .
    
    echo ""
    echo "✅ Multi-architecture image built and pushed successfully!"
    
else
    # Fallback: Build for current architecture only
    echo "⚠️  Warning: Docker Buildx not available. Building for current architecture only..."
    docker build -t ${IMAGE_NAME}:${VERSION} .
    
    echo "Pushing image..."
    docker push ${IMAGE_NAME}:${VERSION}
    
    echo ""
    echo "✅ Single-architecture image built and pushed."
fi

echo ""
echo "=========================================="
echo "Image: ${IMAGE_NAME}:${VERSION}"
echo "=========================================="
echo ""
echo "Next steps:"
echo "  1. Deploy to Kubernetes: flwr-k8s deploy"
echo "  2. Or manually: kubectl apply -f k8s/"
